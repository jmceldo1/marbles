<html>
  <head>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.3.0.js"></script>
    <script type="text/javascript">
      var airconsole;
      var canvas;
      var cards = [];
      var p1 = [];
      var p2 = [];
      var p3 = [];
      var p4 = [];

      /**
       * Sets up the communication to game pads.
       */
      function setupConsole() {
        airconsole = new AirConsole();

        airconsole.onConnect = function(device_id) {
          //Will eventually need 4. Will do two for now for testing purposes
          checkTwoPlayers();
        };

        airconsole.onDisconnect = function(device_id) {
          var player = airconsole.convertDeviceIdToPlayerNumber(device_id);
          if (player != undefined) {
            // Player that was in game left the game.
            // Setting active players to length 0.
            airconsole.setActivePlayers(0);
          }
          checkTwoPlayers();
        };

        airconsole.onMessage = function(device_id, data) {
          var player = airconsole.convertDeviceIdToPlayerNumber(device_id);
          if (player != undefined && data.messageType !== undefined) {
            if (data.messageType === "Deal") {
              dealPlease();
            } else if (data.messageType === "Move") {
              console.log(data.cValue);
            }

          }
        };

      }

      /**
       * Checks if two players are connected!
       */
      function checkTwoPlayers() {
        var active_players = airconsole.getActivePlayerDeviceIds();
        var connected_controllers = airconsole.getControllerDeviceIds();
        // Only update if the game didn't have active players.
        if (active_players.length == 0) {
          if (connected_controllers.length >= 2) {
            // Enough controller devices connected to start the game.
            // Setting the first 2 controllers to active players.
            airconsole.setActivePlayers(2);
            document.getElementById("wait").innerHTML = "";
          } else if (connected_controllers.length == 1) {
            document.getElementById("wait").innerHTML = "Need 1 more player!";
          } else if (connected_controllers.length == 0) {
            document.getElementById("wait").innerHTML = "Need 2 more players!";
          }
        }
      }

      /**
       * body.onload function.
       */
      function init() {
        setupConsole();
        shuffle();

        // Setting up the game. Nothing AirConsole specific.

        canvas = document.getElementById("canvas");
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        window.onresize = (clearCanvas);
      }

      /**
      * Reseting the ball. Nothing Game Console specific.
      * @param move_x
      * @param move_y
      */
      function clearCanvas() {
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "black";
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        ctx.fillRect(0,0, canvas.width, canvas.height);
      }

      function initDeck() {
        var index;
        var max = 52;
        var suit = 'hearts';
        var cardNum = 1;
        for (index = 0; index < max; index++) {
          if (index === 13){
            suit = 'clubs'
            cardNum = 1;
          } else if (index === 26) {
            suit = 'diamonds';
            cardNum = 1;
          } else if (index ===39) {
            suit = "spades";
            cardNum = 1;
          }
          var realCardFace = cardNum;
          if (cardNum === 11) {
            realCardFace = "jack";
          } else if (cardNum === 12) {
            realCardFace = "queen";
          } else if (cardNum === 13) {
            realCardFace = "king";
          } else if (cardNum === 1) {
            realCardFace = "ace"
          }
          var cardFace = realCardFace + "_of_" + suit;
          var cardObj = {ind:index + 1, face:cardFace};
          cards[index] = cardObj;
          cardNum++;
        }
      }

      function shuffle() {
        initDeck()
        var currentIndex = cards.length, temporaryValue, randomIndex;
        while (0 !== currentIndex) {
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          temporaryValue = cards[currentIndex];
          cards[currentIndex] = cards[randomIndex];
          cards[randomIndex] = temporaryValue;
        }

        return cards;
      }

      function dealCards(numOfCards) {
        var fileType = ".png";
        var pNo = 0;
        var cardNo = 0;
        for (i = 0; i <  numOfCards ; i ++) {
          switch (pNo) {
            case 0:
              var cardVal = cards.pop().face;
              //document.getElementById("p1c" + cardNo).src="images/PNG-cards-1.3/" + cardVal + fileType;
              p1[cardNo] = cardVal;
              pNo++;
              break;
            case 1:
              var cardVal = cards.pop().face;
              //document.getElementById("p2c" + cardNo).src="images/PNG-cards-1.3/" + cardVal + fileType;
              p2[cardNo] = cardVal;
              pNo++;
              break;
            case 2:
              var cardVal = cards.pop().face;
              //document.getElementById("p3c" + cardNo).src="images/PNG-cards-1.3/" + cardVal + fileType;
              p3[cardNo] = cardVal;
              pNo++;
              break;
            default:
              var cardVal = cards.pop().face;
              //document.getElementById("p4c" + cardNo).src="images/PNG-cards-1.3/" + cardVal + fileType;
              p4[cardNo] = cardVal;
              pNo = 0;
              cardNo++;
          }
        }
        //Deal to connected_controllers
        var player1DeviceId = airconsole.convertPlayerNumberToDeviceId(0);
        var player1Data = {messageType: "Deal", hand: p1};
        airconsole.message(player1DeviceId, player1Data);
        airconsole.message(airconsole.convertPlayerNumberToDeviceId(1), {messageType: "Deal", hand: p2})
        p1 = [];
        p2 = [];
        p3 = [];
        p4 = [];
      }

      function dealPlease() {

        // var deckElmnt = document.getElementById("demo");

        if (cards.length === 0){
          clearHands();
          shuffle(cards);
          // deckElmnt.innerHTML = "Remaining cards in Deck:" + cards.length;
        }
        else if (cards.length === 52) {
          // clearHands();
          dealCards(20);
          // deckElmnt.innerHTML = "Remaining cards in Deck:" + cards.length;

        }

        else {
          // clearHands();
          dealCards(16);
          // deckElmnt.innerHTML = "Remaining cards in Deck:" + cards.length;

        }
      }

        function clearHands() {
          p1 = [];
          p2 = [];
          p3 = [];
          p4 = [];
          airconsole.broadcast({messageType: "Clear"})
          // var cardElements = document.getElementsByClassName("cards");
          // var i; j = cardElements.length;
          // for (var i = 0; i < j; i++) {
          //   cardElements[i].src = "images/PNG-cards-1.3/haas.jpg";
          // }
        }

      /**
       * Drawing the game scene. Nothing Game Console specific.
       * @param clear
       */
      // function draw(clear) {
      //   // Draw
      //   var ctx = canvas.getContext("2d");
      //   var zoom = canvas.clientHeight / 100;
      //   function c(x) {
      //     x *= zoom;
      //     return x | 0; // round
      //   }
      //   ctx.fillStyle = clear ? 'black' : 'white';
      //
      //   ctx.fillRect(c(paddles[0].pos.x - 1),c(paddles[0].pos.y - 10),
      //                c(2), c(20));
      //   ctx.fillRect(c(paddles[1].pos.x - 1),c(paddles[1].pos.y - 10),
      //                c(2), c(20));
      //
      //   ctx.beginPath();
      //   ctx.arc(c(ball.pos.x), c(ball.pos.y), c(clear ? 3 : 2), 0,
      //           2 * Math.PI, false);
      //   ctx.fill();
      //   ctx.closePath();
      // }
    </script>
    <style type="text/css">
      @font-face {
        font-family: 'PressStart2P';
        src: url('PressStart2P.ttf') format('truetype');
      }

      html, body {
        height: 100%;
        margin: 0px;
        font-family: 'PressStart2P', sans-serif;
        color: white;
        text-align: center;
      }

      .game {
        background-color: black;
        top: 50%;
        margin-top: -25%;
        padding-bottom: 50%;
        overflow: hidden;
        position: relative;
      }

      #canvas {
        position: absolute;
        top: 0px;
        left:0px;
        width: 100%;
        height: 100%;
      }

      #score {
        position: absolute;
        top: 10%;
        left: 0px;
        width: 100%;
        font-size: 48px;
      }

      #wait {
        position: absolute;
        top: 10%;
        margin-top: 80px;
        left: 0px;
        width: 100%;
        font-size: 24px;
        color: lime;
      }
    </style>
  </head>
  <body onload="init()">
    <div class="game">
      <canvas id="canvas"></canvas>
      <div id="score">0:0</div>
      <div id="wait"></div>
    </div>
  </body>
</html>
